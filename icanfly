local CoreGui = game:GetService("StarterGui")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UIS = game:GetService("UserInputService")
local lplayer = Players.LocalPlayer

getgenv().ToggleKey = Enum.KeyCode.L
getgenv().ActionKey = Enum.KeyCode.Z

task.spawn(function()
    while task.wait(0.5) do
        if lplayer then
            pcall(function()
                lplayer.MaximumSimulationRadius = math.huge
                sethiddenproperty(lplayer, "SimulationRadius", math.huge)
            end)
        end
    end
end)

task.spawn(function()
    while task.wait(0.1) do
        if lplayer.Character and lplayer.Character:FindFirstChildOfClass("Humanoid") and lplayer.Character:FindFirstChildOfClass("Humanoid").Health <= 0 then
            local char = lplayer.Character
            if char:FindFirstChild("Head") then
                for _, v in pairs(char:GetDescendants()) do
                    if v:IsA("BasePart") then v:Destroy() end
                end
            end
            task.wait(0.2)
        end
    end
end)

function GetPlayer(String)
    local Found = {}
    local strl = String:lower()
    if strl == "all" then
        for i,v in pairs(Players:GetPlayers()) do table.insert(Found,v) end
    elseif strl == "others" then
        for i,v in pairs(Players:GetPlayers()) do
            if v.Name ~= lplayer.Name then table.insert(Found,v) end
        end 
    elseif strl == "me" then
        table.insert(Found,lplayer)
    else
        for i,v in pairs(Players:GetPlayers()) do
            if v.Name:lower():sub(1, #String) == String:lower() or v.DisplayName:lower():sub(1, #String) == String:lower() then
                table.insert(Found,v)
            end
        end 
    end
    return Found
end

local AutoFlingGui = Instance.new("ScreenGui", game:GetService("CoreGui"))
local AutoFlingFrame = Instance.new("Frame", AutoFlingGui)
AutoFlingFrame.BackgroundColor3 = Color3.new(0, 0, 0)
AutoFlingFrame.BorderColor3 = Color3.new(1,1,1)
AutoFlingFrame.BorderSizePixel = 2
AutoFlingFrame.Position = UDim2.new(0.63, 0, 0.1, 0)
AutoFlingFrame.Size = UDim2.new(0.16, 0, 0.5, 0)
AutoFlingFrame.Active = true
AutoFlingFrame.Draggable = true

local KeySetting = Instance.new("TextBox", AutoFlingFrame)
KeySetting.Size = UDim2.new(0.3, 0, 0.08, 0)
KeySetting.Position = UDim2.new(0.65, 0, -0.1, 0)
KeySetting.BackgroundColor3 = Color3.new(0.1, 0.1, 0.1)
KeySetting.TextColor3 = Color3.new(0, 1, 0)
KeySetting.Text = "L"
KeySetting.TextScaled = true

local KeyLabel = Instance.new("TextLabel", AutoFlingFrame)
KeyLabel.Size = UDim2.new(0.6, 0, 0.08, 0)
KeyLabel.Position = UDim2.new(0.05, 0, -0.1, 0)
KeyLabel.BackgroundTransparency = 1
KeyLabel.TextColor3 = Color3.new(1,1,1)
KeyLabel.Text = "隱藏介面:"
KeyLabel.TextScaled = true
KeyLabel.TextXAlignment = Enum.TextXAlignment.Left

local ActionKeySetting = Instance.new("TextBox", AutoFlingFrame)
ActionKeySetting.Size = UDim2.new(0.3, 0, 0.08, 0)
ActionKeySetting.Position = UDim2.new(0.65, 0, -0.2, 0)
ActionKeySetting.BackgroundColor3 = Color3.new(0.1, 0.1, 0.1)
ActionKeySetting.TextColor3 = Color3.new(1, 0.5, 0)
ActionKeySetting.Text = "Z"
ActionKeySetting.TextScaled = true

local ActionKeyLabel = Instance.new("TextLabel", AutoFlingFrame)
ActionKeyLabel.Size = UDim2.new(0.6, 0, 0.08, 0)
ActionKeyLabel.Position = UDim2.new(0.05, 0, -0.2, 0)
ActionKeyLabel.BackgroundTransparency = 1
ActionKeyLabel.TextColor3 = Color3.new(1,1,1)
ActionKeyLabel.Text = "飛人開關:"
ActionKeyLabel.TextScaled = true
ActionKeyLabel.TextXAlignment = Enum.TextXAlignment.Left

KeySetting.FocusLost:Connect(function()
    local input = KeySetting.Text:upper()
    if #input == 1 then getgenv().ToggleKey = Enum.KeyCode[input] else KeySetting.Text = "L" end
end)

ActionKeySetting.FocusLost:Connect(function()
    local input = ActionKeySetting.Text:upper()
    if #input == 1 then getgenv().ActionKey = Enum.KeyCode[input] else ActionKeySetting.Text = "Z" end
end)

local TextBox = Instance.new("TextBox", AutoFlingFrame)
TextBox.BackgroundColor3 = Color3.new(0, 0, 0)
TextBox.BorderColor3 = Color3.new(1,1,1)
TextBox.Position = UDim2.new(0.1, 0, 0.05, 0)
TextBox.Size = UDim2.new(0.8, 0, 0.15, 0)
TextBox.TextColor3 = Color3.new(1,1,1)
TextBox.TextScaled = true
TextBox.PlaceholderText = "搜尋玩家名稱"

local TextButton = Instance.new("TextButton", AutoFlingFrame)
TextButton.BackgroundColor3 = Color3.new(0, 0, 0)
TextButton.BorderColor3 = Color3.new(1,1,1)
TextButton.Position = UDim2.new(0.2,0,0.8,0)
TextButton.Size = UDim2.new(0.6,0,0.15,0)
TextButton.TextColor3 = Color3.new(1,1,1)
TextButton.Text = "自動飛人"
TextButton.TextScaled = true

local function ToggleFlingLogic()
    if TextButton.Text == "自動飛人" then
        TextButton.Text = "關閉自動飛人"
        task.spawn(ActiveAutoFling)
    else
        TextButton.Text = "自動飛人"
        getgenv().flingloop = false
    end
end

TextButton.MouseButton1Click:Connect(ToggleFlingLogic)

UIS.InputBegan:Connect(function(input, gpe)
    if gpe then return end
    if input.KeyCode == getgenv().ToggleKey then
        AutoFlingFrame.Visible = not AutoFlingFrame.Visible
    elseif input.KeyCode == getgenv().ActionKey then
        ToggleFlingLogic()
    end
end)

local ScrollFrame = Instance.new("ScrollingFrame", AutoFlingFrame)
ScrollFrame.BackgroundColor3 = Color3.fromRGB(30,30,30)
ScrollFrame.Position = UDim2.new(0.05,0,0.25,0)
ScrollFrame.Size = UDim2.new(0.9,0,0.5,0)
ScrollFrame.CanvasSize = UDim2.new(0,0,0,0)
ScrollFrame.ScrollBarThickness = 6

local UIListLayout = Instance.new("UIListLayout", ScrollFrame)
UIListLayout.SortOrder = Enum.SortOrder.LayoutOrder
UIListLayout.Padding = UDim.new(0,2)

local CheckBoxes = {}
local function UpdatePlayerList()
    local oldSelections = {}
    for player, check in pairs(CheckBoxes) do
        if player and player.Parent then oldSelections[player.Name] = check() end
    end
    for _,v in pairs(ScrollFrame:GetChildren()) do if v:IsA("TextButton") then v:Destroy() end end
    CheckBoxes = {}
    for _,p in pairs(Players:GetPlayers()) do
        if p ~= lplayer then
            local btn = Instance.new("TextButton", ScrollFrame)
            btn.Size = UDim2.new(1,0,0,30)
            btn.Text = p.DisplayName
            btn.TextColor3 = Color3.new(1,1,1)
            btn.BackgroundColor3 = Color3.new(0,0,0)
            btn.TextScaled = true
            local selected = oldSelections[p.Name] or false
            if selected then btn.BackgroundColor3 = Color3.fromRGB(0,120,0) end
            btn.MouseButton1Click:Connect(function()
                selected = not selected
                btn.BackgroundColor3 = selected and Color3.fromRGB(0,120,0) or Color3.new(0,0,0)
            end)
            CheckBoxes[p] = function() return selected end
        end
    end
    ScrollFrame.CanvasSize = UDim2.new(0,0,0,#Players:GetPlayers()*32)
end
UpdatePlayerList()
Players.PlayerAdded:Connect(UpdatePlayerList)
Players.PlayerRemoving:Connect(UpdatePlayerList)

function SkidFling(TargetPlayer)
    local Character = lplayer.Character
    local Humanoid = Character and Character:FindFirstChildOfClass("Humanoid")
    local RootPart = Humanoid and Humanoid.RootPart
    local TCharacter = TargetPlayer.Character
    local THumanoid = TCharacter and TCharacter:FindFirstChildOfClass("Humanoid")
    local TRootPart = THumanoid and THumanoid.RootPart
    local THead = TCharacter and TCharacter:FindFirstChild("Head")
    local Accessory = TCharacter and TCharacter:FindFirstChildOfClass("Accessory")
    local Handle = Accessory and Accessory:FindFirstChild("Handle")
    
    if Character and Humanoid and RootPart then
        if RootPart.Velocity.Magnitude < 50 then
            getgenv().OldPos = RootPart.CFrame
        end

        local function SetGhost(bool)
            for _, v in pairs(Players:GetPlayers()) do
                if v ~= lplayer and v ~= TargetPlayer and v.Character then
                    for _, part in pairs(v.Character:GetDescendants()) do
                        if part:IsA("BasePart") then part.CanCollide = not bool end
                    end
                end
            end
        end
        SetGhost(true)

        if THead then workspace.CurrentCamera.CameraSubject = THead
        elseif not THead and Handle then workspace.CurrentCamera.CameraSubject = Handle
        elseif THumanoid and TRootPart then workspace.CurrentCamera.CameraSubject = THumanoid end

        local FPos = function(BasePart, Pos, Ang)
            RootPart.CFrame = CFrame.new(BasePart.Position) * Pos * Ang
            Character:SetPrimaryPartCFrame(CFrame.new(BasePart.Position) * Pos * Ang)
            RootPart.Velocity = Vector3.new(2e8, 2e8 * 10, 2e8)
            RootPart.RotVelocity = Vector3.new(2e9, 2e9, 2e9)
        end

        local SFBasePart = function(BasePart)
            local TimeToWait = 2
            local Time = tick()
            local Angle = 0
            repeat
                if RootPart and THumanoid and BasePart.Parent then
                    if BasePart.Velocity.Magnitude < 50 then
                        Angle = Angle + 100
                        FPos(BasePart, CFrame.new(0, 1.5, 0) + THumanoid.MoveDirection * BasePart.Velocity.Magnitude / 1.25, CFrame.Angles(math.rad(Angle),0 ,0))
                        task.wait()
                        FPos(BasePart, CFrame.new(0, -1.5, 0) + THumanoid.MoveDirection * BasePart.Velocity.Magnitude / 1.25, CFrame.Angles(math.rad(Angle), 0, 0))
                        task.wait()
                        FPos(BasePart, CFrame.new(2.25, 1.5, -2.25) + THumanoid.MoveDirection * BasePart.Velocity.Magnitude / 1.25, CFrame.Angles(math.rad(Angle), 0, 0))
                        task.wait()
                        FPos(BasePart, CFrame.new(-2.25, -1.5, 2.25) + THumanoid.MoveDirection * BasePart.Velocity.Magnitude / 1.25, CFrame.Angles(math.rad(Angle), 0, 0))
                        task.wait()
                        FPos(BasePart, CFrame.new(0, 1.5, 0) + THumanoid.MoveDirection,CFrame.Angles(math.rad(Angle), 0, 0))
                        task.wait()
                        FPos(BasePart, CFrame.new(0, -1.5, 0) + THumanoid.MoveDirection,CFrame.Angles(math.rad(Angle), 0, 0))
                        task.wait()
                    else
                        FPos(BasePart, CFrame.new(0, 1.5, THumanoid.WalkSpeed), CFrame.Angles(math.rad(90), 0, 0))
                        task.wait()
                        FPos(BasePart, CFrame.new(0, -1.5, -THumanoid.WalkSpeed), CFrame.Angles(0, 0, 0))
                        task.wait()
                        FPos(BasePart, CFrame.new(0, 1.5, TRootPart.Velocity.Magnitude / 1.25), CFrame.Angles(math.rad(90), 0, 0))
                        task.wait()
                    end
                else break end
            until BasePart.Velocity.Magnitude > 500 or not getgenv().flingloop or tick() > Time + TimeToWait or (THumanoid and THumanoid.Health <= 0)
        end

        getgenv().FPDH = workspace.FallenPartsDestroyHeight
        workspace.FallenPartsDestroyHeight = 0/0
        
        local BV = Instance.new("BodyVelocity", RootPart)
        BV.Name = "EpixVel"
        BV.Velocity = Vector3.new(9e8, 9e8, 9e8)
        BV.MaxForce = Vector3.new(1/0, 1/0, 1/0)
        
        Humanoid:SetStateEnabled(Enum.HumanoidStateType.Seated, false)

        if TRootPart and THead then
            if (TRootPart.Position - THead.Position).Magnitude > 5 then SFBasePart(THead) else SFBasePart(TRootPart) end
        elseif TRootPart then SFBasePart(TRootPart)
        elseif THead then SFBasePart(THead)
        elseif Handle then SFBasePart(Handle) end

        BV:Destroy()
        Humanoid:SetStateEnabled(Enum.HumanoidStateType.Seated, true)
        workspace.CurrentCamera.CameraSubject = Humanoid
        SetGhost(false)
        
        repeat
            RootPart.CFrame = getgenv().OldPos * CFrame.new(0, .5, 0)
            Character:SetPrimaryPartCFrame(getgenv().OldPos * CFrame.new(0, .5, 0))
            Humanoid:ChangeState("GettingUp")
            for _, x in pairs(Character:GetChildren()) do
                if x:IsA("BasePart") then x.Velocity, x.RotVelocity = Vector3.new(), Vector3.new() end
            end
            task.wait()
        until (RootPart.Position - getgenv().OldPos.Position).Magnitude < 25
        workspace.FallenPartsDestroyHeight = getgenv().FPDH or 0
    end
end

function ActiveAutoFling()
    getgenv().flingloop = true
    while getgenv().flingloop do
        local Targets = {}
        for p, check in pairs(CheckBoxes) do if p and p.Parent and check() then table.insert(Targets, p) end end
        if #Targets == 0 and TextBox.Text ~= "" then
            for _, p in pairs(GetPlayer(TextBox.Text)) do if p ~= lplayer then table.insert(Targets, p) end end
        end

        for _, target in pairs(Targets) do
            if not getgenv().flingloop then break end
            local tHum = target.Character and target.Character:FindFirstChildOfClass("Humanoid")
            local tRoot = target.Character and target.Character:FindFirstChild("HumanoidRootPart")
            if tHum and tHum.Health > 0 and tRoot then
                local myChar = lplayer.Character
                local myRoot = myChar and myChar:FindFirstChild("HumanoidRootPart")
                if myRoot then
                    local distance = (myRoot.Position - tRoot.Position).Magnitude
                    if distance <= 3000 then
                        pcall(function() SkidFling(target) end)
                    end
                end
            end
            task.wait(0.1)
        end
        task.wait(0.5)
    end
end

lplayer.CharacterAdded:Connect(function()
    if getgenv().flingloop then task.wait(1.5); task.spawn(ActiveAutoFling) end
end)
